<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wheel of Fortune Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            padding: 20px;
        }

        .game-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .game-header h1 {
            font-size: 3em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        .game-area {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 30px;
            margin-bottom: 30px;
        }

        .wheel-container {
            flex: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .wheel-wrapper {
            position: relative;
            width: 400px;
            height: 400px;
            margin-bottom: 30px;
        }

        .wheel-svg {
            width: 100%;
            height: 100%;
            transform-origin: center center;
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            filter: drop-shadow(0 8px 25px rgba(0,0,0,0.3));
        }

        .wheel-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid #FFD700;
            z-index: 10;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .section-text {
            font-family: 'Arial', sans-serif;
            font-weight: bold;
            fill: white;
            text-anchor: middle;
            dominant-baseline: central;
            paint-order: stroke fill;
            stroke: rgba(0,0,0,0.8);
            stroke-width: 1px;
            pointer-events: none;
        }

        .controls {
            flex: 1;
            background: rgba(255,255,255,0.9);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .spin-button {
            width: 100%;
            padding: 15px;
            font-size: 1.5em;
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: transform 0.2s;
            font-weight: bold;
        }

        .spin-button:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .spin-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .veto-button {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            background: #FF4444;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 20px;
            font-weight: bold;
            display: none;
        }

        .veto-button:hover {
            background: #CC3333;
        }

        .coin-flip-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .coin-flip-button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .coin {
            width: 80px;
            height: 80px;
            background: #FFD700;
            border-radius: 50%;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            transition: transform 1s ease-in-out;
            border: 3px solid #FFA500;
        }

        .result-display {
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .admin-panel {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .admin-toggle {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .admin-content {
            display: none;
        }

        .csv-input {
            width: 100%;
            height: 200px;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
        }

        .severity-config {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .severity-item {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }

        .severity-item h4 {
            margin-bottom: 10px;
        }

        .severity-item input, .severity-item select {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .validation-error {
            color: #FF4444;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .validation-success {
            color: #4CAF50;
            font-weight: bold;
            margin-bottom: 10px;
        }

        /* Severity styles */
        .severity-low {
            font-size: 12px;
            font-weight: normal;
        }

        .severity-medium {
            font-size: 14px;
            font-weight: bold;
        }

        .severity-high {
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
        }

        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
                align-items: center;
            }
            
            .wheel-wrapper {
                width: 300px;
                height: 300px;
            }
            
            .controls {
                width: 100%;
                max-width: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-header">
            <h1>🎡 Wheel of F****** 🎡</h1>
            <p>Spin the wheel and see what fate has in store!</p>
        </div>

        <div class="game-area">
            <div class="wheel-container">
                <div class="wheel-wrapper">
                    <div class="wheel-pointer"></div>
                    <svg class="wheel-svg" id="wheelSvg" viewBox="0 0 400 400">
                        <!-- Wheel sections will be generated here -->
                    </svg>
                </div>
                
                <div class="controls">
                    <button class="spin-button" id="spinBtn">SPIN THE WHEEL!</button>
                    <button class="veto-button" id="vetoBtn">🚫 VETO & RESPIN</button>
                    
                    <div class="coin-flip-container">
                        <h3>Undecided?</h3>
                        <button class="coin-flip-button" id="coinFlipBtn">Flip Coin</button>
                        <div class="coin" id="coin">👤</div>
                    </div>
                    
                    <div class="result-display" id="resultDisplay">
                        <p>Click "SPIN THE WHEEL!" to get started!</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-panel">
            <button class="admin-toggle" id="adminToggle">Toggle Admin Panel</button>
            <div class="admin-content" id="adminContent">
                <h2>Admin Panel</h2>
                
                <div id="validationMessage"></div>
                
                <h3>CSV Data (prompt_text, percentage_size, color, severity)</h3>
                <textarea class="csv-input" id="csvInput" placeholder="Example:
Dance for 30 seconds,20,#FF6B6B,medium
Tell a joke,15,#4ECDC4,low
Sing your favorite song,25,#45B7D1,high
Do 10 pushups,20,#96CEB4,medium
Share an embarrassing story,20,#FFEAA7,high"></textarea>

            <!-- ✅ Max Slices Input -->
            <h3>Max Slices on Wheel</h3>
            <input type="number" id="maxSlicesInput" value="8" min="1" max="50"
                style="width: 100%; margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">


                <h3>Severity Styling Configuration</h3>
                <div class="severity-config">
                    <div class="severity-item">
                        <h4>Low Severity</h4>
                        <label>Font Size:</label>
                        <input type="number" id="lowFontSize" value="12" min="8" max="24">
                        <label>Font Weight:</label>
                        <select id="lowFontWeight">
                            <option value="normal">Normal</option>
                            <option value="bold">Bold</option>
                        </select>
                        <label>Text Transform:</label>
                        <select id="lowTextTransform">
                            <option value="none">None</option>
                            <option value="uppercase">Uppercase</option>
                            <option value="lowercase">Lowercase</option>
                        </select>
                    </div>
                    
                    <div class="severity-item">
                        <h4>Medium Severity</h4>
                        <label>Font Size:</label>
                        <input type="number" id="mediumFontSize" value="14" min="8" max="24">
                        <label>Font Weight:</label>
                        <select id="mediumFontWeight">
                            <option value="normal">Normal</option>
                            <option value="bold" selected>Bold</option>
                        </select>
                        <label>Text Transform:</label>
                        <select id="mediumTextTransform">
                            <option value="none">None</option>
                            <option value="uppercase">Uppercase</option>
                            <option value="lowercase">Lowercase</option>
                        </select>
                    </div>
                    
                    <div class="severity-item">
                        <h4>High Severity</h4>
                        <label>Font Size:</label>
                        <input type="number" id="highFontSize" value="16" min="8" max="24">
                        <label>Font Weight:</label>
                        <select id="highFontWeight">
                            <option value="normal">Normal</option>
                            <option value="bold" selected>Bold</option>
                        </select>
                        <label>Text Transform:</label>
                        <select id="highTextTransform">
                            <option value="none">None</option>
                            <option value="uppercase" selected>Uppercase</option>
                            <option value="lowercase">Lowercase</option>
                        </select>
                    </div>
                </div>
                
                <button id="updateWheel">Update Wheel</button>
            </div>
        </div>
    </div>

    <script>
           class WheelOfFortune {
      constructor() {
        this.wheelSvg = document.getElementById('wheelSvg');
        this.spinBtn = document.getElementById('spinBtn');
        this.vetoBtn = document.getElementById('vetoBtn');
        this.coinFlipBtn = document.getElementById('coinFlipBtn');
        this.coin = document.getElementById('coin');
        this.resultDisplay = document.getElementById('resultDisplay');
        this.adminToggle = document.getElementById('adminToggle');
        this.adminContent = document.getElementById('adminContent');
        this.csvInput = document.getElementById('csvInput');
        this.updateBtn = document.getElementById('updateWheel');
        this.validationMessage = document.getElementById('validationMessage');
        this.maxSlicesInput = document.getElementById('maxSlicesInput'); // ✅ NEW

        this.currentRotation = 0;
        this.isSpinning = false;
        this.wheelData = [];
        this.lastSelectedIndex = -1;

        this.initializeEventListeners();
        this.loadDefaultData();
        this.setupSeverityListeners();
      }

      initializeEventListeners() {
        this.spinBtn.addEventListener('click', () => this.spinWheel());
        this.vetoBtn.addEventListener('click', () => this.vetoSelection());
        this.coinFlipBtn.addEventListener('click', () => this.flipCoin());
        this.adminToggle.addEventListener('click', () => this.toggleAdmin());
        this.updateBtn.addEventListener('click', () => this.updateWheelData());
        this.csvInput.addEventListener('input', () => this.validateCSV());
        this.maxSlicesInput.addEventListener('change', () => this.updateWheelData()); // ✅ NEW
      }

      loadDefaultData() {
        const defaultCSV = `Dance for 30 seconds,20,#FF6B6B,medium
Tell a joke,15,#4ECDC4,low
Sing your favorite song,25,#45B7D1,high
Do 10 pushups,20,#96CEB4,medium
Share an embarrassing story,20,#FFEAA7,high`;

        this.csvInput.value = defaultCSV;
        this.updateWheelData();
      }

      validateCSV() {
        const csvText = this.csvInput.value.trim();
        if (!csvText) {
          this.showValidationMessage('CSV cannot be empty', 'error');
          return false;
        }

        try {
          const parsed = Papa.parse(csvText, { skipEmptyLines: true });
          const data = parsed.data;

          if (data.length === 0) {
            this.showValidationMessage('No valid data found', 'error');
            return false;
          }

          const errors = [];
          let totalPercentage = 0;

          data.forEach((row, index) => {
            if (row.length !== 4) {
              errors.push(`Row ${index + 1}: Must have exactly 4 columns`);
              return;
            }

            const [text, percentage, color, severity] = row;
            const percentNum = parseFloat(percentage);

            if (!text.trim()) errors.push(`Row ${index + 1}: Text cannot be empty`);
            if (isNaN(percentNum) || percentNum <= 0) errors.push(`Row ${index + 1}: Invalid percentage`);
            else totalPercentage += percentNum;

            if (!/^#[0-9A-Fa-f]{6}$/.test(color.trim()))
              errors.push(`Row ${index + 1}: Invalid color format`);

            if (!['low', 'medium', 'high'].includes(severity.trim()))
              errors.push(`Row ${index + 1}: Invalid severity value`);
          });

          if (errors.length > 0) {
            this.showValidationMessage(errors.join('<br>'), 'error');
            return false;
          }

          this.showValidationMessage('CSV validation successful!', 'success');
          return true;
        } catch (e) {
          this.showValidationMessage(`CSV parsing error: ${e.message}`, 'error');
          return false;
        }
      }

      showValidationMessage(message, type) {
        this.validationMessage.innerHTML = message;
        this.validationMessage.className =
          type === 'error' ? 'validation-error' :
          type === 'success' ? 'validation-success' : '';
      }

      updateWheelData() {
        if (!this.validateCSV()) return;

        const csvText = this.csvInput.value.trim();
        const parsed = Papa.parse(csvText, { skipEmptyLines: true });
        const data = parsed.data;

        const maxSlices = parseInt(this.maxSlicesInput.value) || data.length;
        const shuffledData = [...data].sort(() => 0.5 - Math.random());
        const limitedData = shuffledData.slice(0, maxSlices);

        let totalPercentage = limitedData.reduce((sum, row) => sum + parseFloat(row[1]), 0);

        this.wheelData = limitedData.map(row => ({
          text: row[0].trim(),
          percentage: (parseFloat(row[1]) / totalPercentage) * 100,
          color: row[2].trim(),
          severity: row[3].trim()
        }));

        this.renderWheel();
        this.updateSeverityStyles();
        this.vetoBtn.style.display = 'none';
        this.resultDisplay.innerHTML = '<p>Wheel updated! Click "SPIN THE WHEEL!" to play.</p>';
      }
            
            renderWheel() {
                // Clear existing content
                this.wheelSvg.innerHTML = '';

                // Reset any previous rotation
                this.wheelSvg.style.transition = 'none';
                this.wheelSvg.style.transform = `rotate(${this.currentRotation}deg)`;

                const centerX = 200;
                const centerY = 200;
                const radius = 180;

                let currentAngle = -90; // Start from top (12 o'clock position)

                this.wheelData.forEach((section, index) => {
                    const sectionAngle = (section.percentage / 100) * 360;
                    const startAngle = currentAngle;
                    const endAngle = currentAngle + sectionAngle;

                    // Create path for triangular section
                    const startAngleRad = (startAngle * Math.PI) / 180;
                    const endAngleRad = (endAngle * Math.PI) / 180;

                    const x1 = centerX + radius * Math.cos(startAngleRad);
                    const y1 = centerY + radius * Math.sin(startAngleRad);
                    const x2 = centerX + radius * Math.cos(endAngleRad);
                    const y2 = centerY + radius * Math.sin(endAngleRad);

                    const largeArcFlag = sectionAngle > 180 ? 1 : 0;

                    const pathData = [
                        `M ${centerX} ${centerY}`,
                        `L ${x1} ${y1}`,
                        `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
                        'Z'
                    ].join(' ');

                    // Create section path
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', pathData);
                    path.setAttribute('fill', section.color);
                    path.setAttribute('stroke', '#fff');
                    path.setAttribute('stroke-width', '2');
                    this.wheelSvg.appendChild(path);

                    // Add text along the arc
                    const midAngle = (startAngle + endAngle) / 2;
                    const textRadius = radius * 0.65;
                    const textAngle = (midAngle * Math.PI) / 180;

                    const textX = centerX + textRadius * Math.cos(textAngle);
                    const textY = centerY + textRadius * Math.sin(textAngle);

                    const arcLength = 2 * Math.PI * textRadius * (sectionAngle / 360);

                    // Start with severity font size
                    const severityFontSize = parseInt(document.getElementById(`${section.severity}FontSize`).value) || 14;
                    let fontSize = severityFontSize;
                    const minFontSize = 8;

                    const tempText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    tempText.setAttribute('font-size', fontSize);
                    tempText.setAttribute('font-family', 'Arial');
                    tempText.textContent = section.text;
                    this.wheelSvg.appendChild(tempText);
                    let bbox = tempText.getBBox();
                    this.wheelSvg.removeChild(tempText);

                    while (bbox.width > arcLength && fontSize > minFontSize) {
                        fontSize -= 1;
                        tempText.setAttribute('font-size', fontSize);
                        this.wheelSvg.appendChild(tempText);
                        bbox = tempText.getBBox();
                        this.wheelSvg.removeChild(tempText);
                    }

                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', textX);
                    text.setAttribute('y', textY);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('dominant-baseline', 'central');
                    text.setAttribute('font-family', 'Arial, sans-serif');
                    text.setAttribute('font-weight', 'bold');
                    text.setAttribute('fill', 'white');
                    text.setAttribute('font-size', fontSize);
                    text.setAttribute('paint-order', 'stroke fill');
                    text.setAttribute('stroke', 'rgba(0,0,0,0.8)');
                    text.setAttribute('stroke-width', '1px');

                    let textRotation = midAngle + 90;
                    if (textRotation > 90 && textRotation < 270) {
                        textRotation += 180;
                    }
                    text.setAttribute('transform', `rotate(${textRotation}, ${textX}, ${textY})`);

                    if (fontSize <= minFontSize) {
                        text.textContent = '...';
                        const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
                        title.textContent = section.text;
                        text.appendChild(title);
                    } else {
                        text.textContent = section.text;
                    }

                    this.wheelSvg.appendChild(text);
                    currentAngle += sectionAngle;
                });

                // Re-enable transitions after a brief delay
                setTimeout(() => {
                    this.wheelSvg.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
                }, 50);
            }

            
            updateSeverityStyles() {
                const severities = ['low', 'medium', 'high'];
                
                severities.forEach(severity => {
                    const fontSizeEl = document.getElementById(`${severity}FontSize`);
                    const fontWeightEl = document.getElementById(`${severity}FontWeight`);
                    const textTransformEl = document.getElementById(`${severity}TextTransform`);
                    
                    if (!fontSizeEl || !fontWeightEl || !textTransformEl) return;
                    
                    const fontSize = fontSizeEl.value;
                    const fontWeight = fontWeightEl.value;
                    const textTransform = textTransformEl.value;
                    
                    // Remove existing style element for this severity
                    const existingStyle = document.getElementById(`severity-${severity}-style`);
                    if (existingStyle) {
                        existingStyle.remove();
                    }
                    
                    // Create new style element
                    const style = document.createElement('style');
                    style.id = `severity-${severity}-style`;
                    style.textContent = `
                        .severity-${severity} {
                            font-size: ${fontSize}px !important;
                            font-weight: ${fontWeight} !important;
                            text-transform: ${textTransform} !important;
                        }
                    `;
                    document.head.appendChild(style);
                });
            }
            
            spinWheel() {
                if (this.isSpinning) return;
                
                this.isSpinning = true;
                this.spinBtn.disabled = true;
                this.vetoBtn.style.display = 'none';
                this.resultDisplay.innerHTML = '<p>Spinning...</p>';
                
                // Generate random spin (4-8 full rotations plus random angle)
                const spins = 4 + Math.random() * 4;
                const randomAngle = Math.random() * 360;
                const totalRotation = spins * 360 + randomAngle;
                
                this.currentRotation += totalRotation;
                
                // Apply rotation with proper CSS transform
                this.wheelSvg.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
                this.wheelSvg.style.transform = `rotate(${this.currentRotation}deg)`;
                
                setTimeout(() => {
                    this.isSpinning = false;
                    this.spinBtn.disabled = false;
                    
                    // Calculate which section was selected
                    const normalizedAngle = (360 - (this.currentRotation % 360)) % 360;
                    this.lastSelectedIndex = this.getSelectedSection(normalizedAngle);
                    
                    if (this.lastSelectedIndex !== -1) {
                        const selectedSection = this.wheelData[this.lastSelectedIndex];
                        this.resultDisplay.innerHTML = `
                            <div>
                                <h3>You got:</h3>
                                <p class="severity-${selectedSection.severity}" style="font-size: 1.2em; margin-top: 10px;">
                                    ${selectedSection.text}
                                </p>
                            </div>
                        `;
                        this.vetoBtn.style.display = 'block';
                    }
                }, 4000);
            }
            
            getSelectedSection(angle) {
                // Adjust for starting position (-90 degrees)
                const adjustedAngle = (angle + 90) % 360;
                let currentAngle = 0;
                
                for (let i = 0; i < this.wheelData.length; i++) {
                    const sectionAngle = (this.wheelData[i].percentage / 100) * 360;
                    if (adjustedAngle >= currentAngle && adjustedAngle < currentAngle + sectionAngle) {
                        return i;
                    }
                    currentAngle += sectionAngle;
                }
                
                return 0; // Fallback to first section
            }
            
            vetoSelection() {
                if (this.lastSelectedIndex === -1) return;
                
                // Remove the vetoed section
                this.wheelData.splice(this.lastSelectedIndex, 1);
                
                // Renormalize percentages
                const totalPercentage = this.wheelData.reduce((sum, section) => sum + section.percentage, 0);
                if (totalPercentage > 0) {
                    this.wheelData.forEach(section => {
                        section.percentage = (section.percentage / totalPercentage) * 100;
                    });
                }
                
                this.renderWheel();
                this.vetoBtn.style.display = 'none';
                this.resultDisplay.innerHTML = '<p>Section vetoed! Spin again to get a new result.</p>';
                this.lastSelectedIndex = -1;
                
                if (this.wheelData.length === 0) {
                    this.resultDisplay.innerHTML = '<p>No more sections left! Please reload the wheel in the admin panel.</p>';
                    this.spinBtn.disabled = true;
                }
            }
            
            flipCoin() {
                const coin = this.coin;
                const isHeads = Math.random() < 0.5;
                
                // Animate coin flip
                coin.style.transform = 'rotateY(1800deg)';
                
                setTimeout(() => {
                    coin.innerHTML = isHeads ? '👨🏻' : '👩🏿';
                    coin.style.transform = 'rotateY(0deg)';
                }, 1000);
            }
            
            toggleAdmin() {
                const content = this.adminContent;
                content.style.display = content.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Initialize the game when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new WheelOfFortune();
        });
    </script>
</body>
</html>